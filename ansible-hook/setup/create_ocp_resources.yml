- name: Get an OCP token
  community.kubernetes.k8s_auth:
    username: "{{ cluster.username }}"
    password: "{{ cluster.password }}"
    host: "https://api.{{ cluster.cluster_domain }}:6443"
    validate_certs: no
  register: k8s_auth_result

- set_fact:
    ocp_token: '{{ k8s_auth_result.k8s_auth.api_key }}'

- name: Create Tower Secret in acm-demo namespace
  k8s:
    host: "https://api.{{ cluster.cluster_domain }}:6443"
    validate_certs: no
    api_key: '{{ ocp_token }}'
    definition: "{{ lookup('template', './templates/tower-secret.yml.j2') | from_yaml }}"  

- name: Get a list of operator groups
  k8s_info:
    api_version: operators.coreos.com/v1
    kind: OperatorGroup
    namespace: acm-demo
  register: operator_groups

- set_fact:
    operator_group_name: '{{ operator_groups.resources[0].metadata.name }}'
  when: operator_groups.resources

- name: Ensure OperatorGroup exists
  k8s:
    definition: '{{ lookup("template", "./templates/operator-group.yml.j2") }}'

- name: Subscribe to AAP Resource Operator
  k8s:
    host: "https://api.{{ cluster.cluster_domain }}:6443"
    validate_certs: no
    api_key: '{{ ocp_token }}'
    definition: "{{ lookup('template', './templates/aapro-subscription.yml.j2') }}"

# Looks like ACM doesn't have perms to apply this. I add this in the /app directory before
# but it was holding up the Reconciliation
- name: Create ClusterRoleBinding to allow acm-demo service-account to read node info
  k8s:
    host: "https://api.{{ cluster.cluster_domain }}:6443"
    validate_certs: no
    api_key: '{{ ocp_token }}'
    definition: "{{ lookup('template', './templates/cluster_role_binding.yml.j2') }}"
